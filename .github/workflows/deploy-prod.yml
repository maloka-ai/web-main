name: Build & Deploy Produ√ß√£o

on:
  push:
    tags:
      - 'v*'   # Somente tags de vers√£o como v1.2.0

env:
  DOCKER_REGISTRY: ghcr.io/maloka-ai
  PROJECT_NAME: web-main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Definir tag de produ√ß√£o
        run: |
          PROD_TAG=${GITHUB_REF##*/}
          echo "PROD_TAG=$PROD_TAG" >> $GITHUB_ENV

      - name: Login no Docker GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build e Push da imagem Docker Next.js (.env.production)
        run: |
          IMAGE="${{ env.DOCKER_REGISTRY }}/${{ env.PROJECT_NAME }}:$PROD_TAG"
          echo "Building image $IMAGE"
          docker build --build-arg ENV_FILE=.env.production --no-cache -t $IMAGE .
          docker push $IMAGE

      - name: Clonar reposit√≥rio de manifests
        uses: actions/checkout@v4
        with:
          repository: maloka-ai/gitops
          token: ${{ secrets.GHCR_TOKEN }}
          path: manifests

      - name: Atualizar tag da imagem no deploy.yaml de produ√ß√£o
        run: |
            cd manifests
            sed -i "s|^\(\s*image:\s*ghcr.io/maloka-ai/web-main:\).*|\1$PROD_TAG|" web-main/prod/deploy.yaml
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add web-main/prod/deploy.yaml
            if ! git diff --cached --quiet; then
              git commit -m "Atualiza web-main para $PROD_TAG em produ√ß√£o"
              git push
            else
              echo "Nenhuma altera√ß√£o para commit/push."
            fi

      - name: Notificar no Discord de Implanta√ß√£o em Produ√ß√£o
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_ACTOR: ${{ github.actor }}
          PROD_TAG: ${{ env.PROD_TAG }}
        run: |
            COMMIT_HASH="${GITHUB_SHA::7}"
            COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
            DATE_MSG=$(TZ=America/Manaus date +"%d/%m/%Y %H:%M")
            
            MSG="üöÄ *Deploy Produ√ß√£o*:\n\
            - üì¶ **Aplica√ß√£o:** WEB-MAIN \n\
            - üì¶ **Imagem:** \`${{ env.DOCKER_REGISTRY }}/${{ env.PROJECT_NAME }}:${PROD_TAG}\`\n\
            - üìù **Commit:** [${COMMIT_HASH}](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA}) - ${COMMIT_MESSAGE}\n\
            - üë§ **Autor:** ${{ github.actor }}\n\
            - üïì **Hor√°rio:** ${DATE_MSG}"
            
            curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"$MSG\"}" "$DISCORD_WEBHOOK_URL"
